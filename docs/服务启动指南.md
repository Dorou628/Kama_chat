# KamaChat 服务启动指南

本文档详细说明了 KamaChat 项目中各个服务的启动方式和配置要求。

## 目录
- [Redis 服务](#redis-服务)
- [后端服务](#后端服务)
- [前端服务](#前端服务)
- [完整启动流程](#完整启动流程)
- [常见问题](#常见问题)

## Redis 服务

### 安装要求
- Redis 版本：推荐 6.0 或更高版本
- 安装路径：`C:\Redis\` （Windows）

### 配置文件
Redis 配置文件位置：`C:\Redis\redis.windows.conf`

**重要配置项：**
```conf
# 端口配置
port 6379

# 密码配置（如果需要）
# requirepass your_password

# 持久化配置
save 900 1
save 300 10
save 60 10000

# 日志级别
loglevel notice

# 最大内存配置
maxmemory 256mb
maxmemory-policy allkeys-lru
```

### 启动方式

#### 方式一：直接启动（推荐）
```powershell
# 在项目根目录下执行
C:\Redis\redis-server.exe C:\Redis\redis.windows.conf
```

#### 方式二：使用批处理脚本
项目提供了启动脚本：
- `start_services.bat` - Windows 批处理脚本
- `start_services.ps1` - PowerShell 脚本

#### 方式三：Windows 服务方式
```powershell
# 安装为 Windows 服务
redis-server --service-install C:\Redis\redis.windows.conf --loglevel verbose

# 启动服务
redis-server --service-start

# 停止服务
redis-server --service-stop

# 卸载服务
redis-server --service-uninstall
```

### 验证 Redis 启动
```powershell
# 使用 redis-cli 连接测试
C:\Redis\redis-cli.exe ping
# 应该返回 PONG
```

### Redis 数据持久化
- 数据文件：`dump.rdb`（项目根目录）
- 自动备份：根据配置文件中的 save 参数自动保存
- 手动备份：在 redis-cli 中执行 `BGSAVE` 命令

## 后端服务

### 环境要求
- Go 版本：1.19 或更高
- 依赖：MySQL、Redis

### 配置文件
配置文件位置：`configs/config.toml`

**主要配置项：**
```toml
[mainConfig]
port = 8000
httpsPort = 8000
enableHttps = true

[mysqlConfig]
host = "localhost"
port = 3306
username = "root"
password = "your_password"
database = "kama_chat"

[redisConfig]
host = "localhost"
port = 6379
password = ""
database = 0

[authCodeConfig]
accessKeyID = "your_aliyun_access_key_id"
accessKeySecret = "your_aliyun_access_key_secret"
signName = "your_sms_sign_name"
templateCode = "your_sms_template_code"
```

### 启动方式
```powershell
# 在项目根目录下执行
go run cmd/kama_chat_server/main.go
```

### SSL 证书配置
项目使用 HTTPS，证书文件位于 `pkg/ssl/` 目录：
- `127.0.0.1+2.pem` - 证书文件
- `127.0.0.1+2-key.pem` - 私钥文件

### 验证后端启动
```powershell
# 测试 API 连接
Invoke-WebRequest -Uri "https://localhost:8000/login" -Method POST -Body '{"phone":"test","password":"test"}' -ContentType "application/json" -SkipCertificateCheck
```

## 前端服务

### 环境要求
- Node.js 版本：14.0 或更高
- npm 或 yarn

### 项目路径
前端项目位于：`web/chat-server/`

### 依赖安装
```powershell
cd web/chat-server
npm install
```

### 配置文件
前端配置位于：`web/chat-server/src/store/index.js`

**重要配置：**
```javascript
const backendUrl = 'https://localhost:8000'  // 后端 API 地址
const wsUrl = 'wss://localhost:8000'         // WebSocket 地址
```

### 启动方式
```powershell
cd web/chat-server
npm run serve
```

### 访问地址
- 开发服务器：`https://localhost:443/`
- 注意：首次访问可能需要接受自签名证书

## 完整启动流程

### 自动启动（推荐）
使用项目提供的启动脚本：
```powershell
# PowerShell 脚本
.\start_services.ps1

# 或批处理脚本
.\start_services.bat
```

### 手动启动
按以下顺序启动服务：

1. **启动 Redis**
   ```powershell
   C:\Redis\redis-server.exe C:\Redis\redis.windows.conf
   ```

2. **启动后端服务**
   ```powershell
   go run cmd/kama_chat_server/main.go
   ```

3. **启动前端服务**
   ```powershell
   cd web/chat-server
   npm run serve
   ```

### 停止服务
使用停止脚本：
```powershell
.\stop_services.ps1
```

或手动停止：
- 前端服务：在终端中按 `Ctrl+C`
- 后端服务：在终端中按 `Ctrl+C`
- Redis 服务：在终端中按 `Ctrl+C` 或使用 `redis-cli shutdown`

## 常见问题

### Redis 相关问题

**Q: Redis 启动失败，提示端口被占用**
```
A: 检查端口占用情况：
netstat -ano | findstr :6379
如果端口被占用，可以：
1. 杀死占用进程
2. 修改 Redis 配置文件中的端口
```

**Q: Redis 数据丢失**
```
A: 检查以下几点：
1. 确认 dump.rdb 文件是否存在
2. 检查 Redis 配置文件中的 save 参数
3. 确保 Redis 正常关闭（避免强制杀进程）
```

**Q: Redis 内存不足**
```
A: 调整配置文件中的 maxmemory 设置：
maxmemory 512mb  # 根据实际情况调整
```

### 后端服务问题

**Q: 后端启动失败，数据库连接错误**
```
A: 检查 MySQL 服务是否启动，配置文件中的数据库信息是否正确
```

**Q: HTTPS 证书错误**
```
A: 确保 pkg/ssl/ 目录下的证书文件存在且有效
```

### 前端服务问题

**Q: 前端无法连接后端**
```
A: 检查 src/store/index.js 中的 backendUrl 配置是否正确
```

**Q: 浏览器提示证书不安全**
```
A: 这是正常现象（自签名证书），点击"高级"→"继续访问"即可
```

## 开发建议

1. **开发环境**：建议使用自动启动脚本，提高开发效率
2. **生产环境**：建议将 Redis 安装为 Windows 服务，确保系统重启后自动启动
3. **监控**：定期检查各服务的运行状态和日志
4. **备份**：定期备份 Redis 数据和数据库

## 更新日志

- 2024-01-XX：初始版本，包含基本的服务启动说明
- 2024-01-XX：添加 Redis 详细配置和常见问题解决方案