# KamaChat 混合模式测试文档

## 功能概述
混合模式是一个智能的消息处理方案，结合了channel和kafka的优势：
- **正常负载**：使用channel进行快速消息传递
- **高负载**：自动切换到kafka进行消息分流，避免消息丢失
- **动态监控**：实时监控channel负载情况，智能切换

## 配置参数

在 `configs/config.toml` 中的混合模式配置：

```toml
[kafkaConfig]
messageMode = "hybrid"  # 设置为混合模式
hybridThreshold = 0.8   # 触发切换的阈值比例 (4/5 = 0.8)
hybridMonitorInterval = 1  # 监控间隔时间(秒)
hybridSwitchDuration = 5   # 持续时间阈值(秒)
```

## 测试步骤

### 1. 基础功能测试
- [ ] 启动服务器，验证混合模式正常初始化
- [ ] 测试正常消息发送和接收
- [ ] 验证WebSocket连接正常建立

### 2. 负载切换测试
- [ ] 模拟高并发消息发送
- [ ] 观察channel负载监控
- [ ] 验证自动切换到kafka模式
- [ ] 验证负载降低后切换回channel模式

### 3. 性能测试
- [ ] 测试channel模式下的消息延迟
- [ ] 测试kafka模式下的消息延迟
- [ ] 测试模式切换的响应时间
- [ ] 验证消息不丢失

### 4. 稳定性测试
- [ ] 长时间运行测试
- [ ] 频繁切换模式测试
- [ ] 异常情况处理测试

## 验证要点

1. **消息完整性**：确保在模式切换过程中消息不丢失
2. **性能表现**：混合模式应该在不同负载下都有良好表现
3. **自动切换**：监控机制应该准确检测负载并及时切换
4. **配置灵活性**：配置参数应该能够有效控制切换行为

## 预期效果

- 低负载时享受channel的低延迟优势
- 高负载时利用kafka的高吞吐能力
- 智能切换，无需人工干预
- 整体系统稳定性和可扩展性提升